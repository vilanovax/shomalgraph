generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  BUSINESS_OWNER
}

enum PlaceType {
  NATURE
  HISTORICAL
  ENTERTAINMENT
  CULTURAL
  BEACH
  MOUNTAIN
  FOREST
  WATERFALL
  PARK
  OTHER
}

enum RestaurantPriceRange {
  BUDGET      // ارزان
  MODERATE    // متوسط
  EXPENSIVE   // گران
  LUXURY      // لاکچری
}

enum SuitableFor {
  FAMILY
  COUPLE
  FRIENDS
  SOLO
  KIDS
}

model User {
  id            String    @id @default(cuid())
  phone         String    @unique
  name          String?
  avatar        String?
  role          UserRole  @default(USER)
  
  // امتیاز و جریمه
  score         Int       @default(0) // امتیاز کاربر (مثبت یا منفی)
  commentBanUntil DateTime? // تاریخ پایان ممنوعیت کامنت
  isCommentBanned Boolean @default(false) // آیا در حال حاضر ممنوع است
  placeAddBanUntil DateTime? // تاریخ پایان ممنوعیت اضافه کردن مکان
  isPlaceAddBanned Boolean @default(false) // آیا از اضافه کردن مکان محروم است
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  reviews       Review[]
  favorites     Favorite[]
  suggestions   Suggestion[]
  restaurants   Restaurant[]  @relation("RestaurantOwner")

  // Explore Lists Relations
  lists         List[]        @relation("ListCreator")
  itemLikes     ItemLike[]    @relation("ItemLikes")
  itemDislikes  ItemDislike[] @relation("ItemDislikes")
  itemComments  ItemComment[] @relation("ItemComments")
  commentLikes  CommentLike[] @relation("CommentLikes")
  commentReports CommentReport[] @relation("CommentReports")
  listLikes     ListLike[]    @relation("ListLikes")
  itemSuggestions ItemSuggestion[] @relation("ItemSuggestions")
  travelPlans   TravelPlan[]  @relation("TravelPlans")
  checklistTemplates TravelChecklistTemplate[] @relation("ChecklistTemplateCreator")
  checklists    TravelChecklist[] @relation("UserChecklists")
  
  // Comments Relations
  comments      Comment[]     @relation("CommentAuthor")
  commentLikesNew CommentLikeNew[] @relation("CommentLikeUser")
  commentReportsNew CommentReportNew[] @relation("CommentReportUser")

  @@index([phone])
  @@index([score])
  @@map("users")
}

model Category {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  icon          String?
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  restaurants   Restaurant[]
  places        TouristPlace[]

  @@map("categories")
}

model Restaurant {
  id              String                @id @default(cuid())
  name            String
  slug            String                @unique
  description     String?
  address         String
  latitude        Float
  longitude       Float
  phone           String?
  priceRange      RestaurantPriceRange  @default(MODERATE)
  rating          Float                 @default(0)
  reviewCount     Int                   @default(0)
  images          String[]              @default([])
  menuImages      String[]              @default([])
  workingHours    Json?
  isVerified      Boolean               @default(false)
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  categoryId      String?
  category        Category?             @relation(fields: [categoryId], references: [id])
  ownerId         String?
  owner           User?                 @relation("RestaurantOwner", fields: [ownerId], references: [id])
  reviews         Review[]
  favorites       Favorite[]
  listItems       ListItem[]
  travelPlanItems TravelPlanItem[]
  comments        Comment[]             @relation("RestaurantComments")

  @@index([latitude, longitude])
  @@index([slug])
  @@index([categoryId])
  @@map("restaurants")
}

model TouristPlace {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  description     String?
  address         String
  latitude        Float
  longitude       Float
  placeType       PlaceType     @default(OTHER)
  suitableFor     SuitableFor[] @default([])
  rating          Float         @default(0)
  reviewCount     Int           @default(0)
  images          String[]      @default([])
  entryFee        Float?
  isFree          Boolean       @default(true)
  workingHours    Json?
  isVerified      Boolean       @default(false)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  categoryId      String?
  category        Category?     @relation(fields: [categoryId], references: [id])
  reviews         Review[]
  favorites       Favorite[]
  listItems       ListItem[]
  travelPlanItems TravelPlanItem[]
  comments        Comment[]     @relation("PlaceComments")

  @@index([latitude, longitude])
  @@index([slug])
  @@index([placeType])
  @@map("tourist_places")
}

model Review {
  id              String    @id @default(cuid())
  rating          Int       // 1-5
  comment         String?
  images          String[]  @default([])
  isVerified      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId    String?
  restaurant      Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  placeId         String?
  place           TouristPlace? @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([restaurantId])
  @@index([placeId])
  @@map("reviews")
}

model Favorite {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId    String?
  restaurant      Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  placeId         String?
  place           TouristPlace? @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@unique([userId, placeId])
  @@index([userId])
  @@map("favorites")
}

model Suggestion {
  id              String    @id @default(cuid())
  type            String    // "restaurant" | "place"
  data            Json      // اطلاعات پیشنهادی
  comment         String?
  status          String    @default("pending") // pending, approved, rejected
  adminComment    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("suggestions")
}

// ==================== Explore Lists Feature ====================

enum ListType {
  PUBLIC    // لیست‌های عمومی (ادمین)
  PRIVATE   // لیست‌های شخصی (کاربر)
}

model List {
  id            String    @id @default(cuid())
  title         String
  description   String?
  slug          String    @unique
  type          ListType  @default(PUBLIC)
  coverImage    String?
  keywords      String[]  @default([])

  createdById   String
  createdBy     User      @relation("ListCreator", fields: [createdById], references: [id], onDelete: Cascade)

  items         ListItem[]
  likes         ListLike[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([type])
  @@index([createdById])
  @@map("lists")
}

model ListItem {
  id            String    @id @default(cuid())
  listId        String
  list          List      @relation(fields: [listId], references: [id], onDelete: Cascade)

  // آیتم می‌تونه رستوران یا مکان باشه
  restaurantId  String?
  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  placeId       String?
  place         TouristPlace? @relation(fields: [placeId], references: [id], onDelete: Cascade)

  order         Int       // ترتیب نمایش در لیست
  note          String?   // یادداشت ادمین درباره این آیتم

  likes         ItemLike[]
  dislikes      ItemDislike[]
  comments      ItemComment[]

  createdAt     DateTime  @default(now())

  @@index([listId])
  @@map("list_items")
}

model ItemLike {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation("ItemLikes", fields: [userId], references: [id], onDelete: Cascade)
  itemId    String
  item      ListItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([userId, itemId])
  @@index([itemId])
  @@map("item_likes")
}

model ItemDislike {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation("ItemDislikes", fields: [userId], references: [id], onDelete: Cascade)
  itemId    String
  item      ListItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([userId, itemId])
  @@index([itemId])
  @@map("item_dislikes")
}

model ItemComment {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation("ItemComments", fields: [userId], references: [id], onDelete: Cascade)
  itemId    String
  item      ListItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  comment   String

  likes     CommentLike[]
  reports   CommentReport[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([itemId])
  @@map("item_comments")
}

model CommentLike {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation("CommentLikes", fields: [userId], references: [id], onDelete: Cascade)
  commentId String
  comment   ItemComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([userId, commentId])
  @@index([commentId])
  @@map("comment_likes")
}

model CommentReport {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation("CommentReports", fields: [userId], references: [id], onDelete: Cascade)
  commentId String
  comment   ItemComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reason    String
  status    String      @default("pending") // pending, reviewed, resolved
  createdAt DateTime    @default(now())

  @@index([commentId])
  @@index([status])
  @@map("comment_reports")
}

model ListLike {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("ListLikes", fields: [userId], references: [id], onDelete: Cascade)
  listId    String
  list      List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, listId])
  @@index([listId])
  @@map("list_likes")
}

model ItemSuggestion {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("ItemSuggestions", fields: [userId], references: [id], onDelete: Cascade)
  listId      String?  // لیست پیشنهادی (اختیاری)

  // آیتم پیشنهادی
  restaurantId String?
  placeId      String?

  note        String?  // توضیحات کاربر
  adminNote   String?  // پاسخ ادمین
  status      String   @default("pending") // pending, approved, rejected

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("item_suggestions")
}

// ==================== Settings ====================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  category  String   @default("general") // general, api, storage, etc.
  description String?
  isSecret  Boolean  @default(false) // برای کلیدهای API که نباید نمایش داده شوند
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([key])
  @@map("settings")
}

// ==================== Travel Planning ====================

enum PlanType {
  QUICK      // برنامه فوری
  DAILY      // برنامه روزانه
  TRIP       // برنامه کلی چندروزه
}

enum TravelType {
  SOLO
  COUPLE
  FAMILY_WITH_KIDS
  FAMILY_ADULTS
  FRIENDS
}

enum AvailableTime {
  ONE_TO_TWO_HOURS    // 1-2 ساعت
  HALF_DAY            // نیم روز
  FULL_DAY            // کل روز
}

enum Budget {
  ECONOMIC
  MODERATE
  LUXURY
  ANY
}

enum TravelStyle {
  ADVENTUROUS
  RELAXED
  CULTURAL
  MIXED
}

enum PlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum TimeSlot {
  MORNING
  NOON
  AFTERNOON
  EVENING
  NIGHT
}

enum PlanItemType {
  RESTAURANT
  PLACE
  ACTIVITY
  TRAVEL
}

model TravelPlan {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation("TravelPlans", fields: [userId], references: [id], onDelete: Cascade)
  
  title           String?
  description     String?
  
  planType        PlanType      // QUICK, DAILY, TRIP
  travelType      TravelType?
  availableTime   AvailableTime? // برای Quick Plan
  travelStyle     TravelStyle?  // برای Trip Plan
  
  // موقعیت و محدوده
  latitude        Float
  longitude       Float
  address         String
  searchRadius    Int           @default(5) // محدوده جستجو به کیلومتر (0-50)
  
  // زمان‌بندی
  startDate       DateTime?
  endDate         DateTime?
  startTime       String?       // برای Daily Plan (مثلاً "10:00")
  endTime         String?       // برای Daily Plan (مثلاً "22:00")
  
  // ترجیحات
  budget          Budget?       @default(ANY)
  preferences     Json?        // اولویت‌ها (طبیعت، غذا، خرید و...)
  interests       Json?        // علایق انتخاب شده
  
  // خلاصه برنامه
  estimatedCost   Float?
  totalDistance   Float?       // مسافت کل به کیلومتر
  totalDuration   Int?         // مدت کل به دقیقه
  
  status          PlanStatus   @default(DRAFT)
  isShared        Boolean      @default(false)
  
  items           TravelPlanItem[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([planType])
  @@index([status])
  @@map("travel_plans")
}

model TravelPlanItem {
  id              String        @id @default(cuid())
  planId          String
  plan            TravelPlan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  order           Int           // ترتیب در برنامه
  dayNumber       Int?          // برای Trip Plan: روز 1، 2، 3...
  
  timeSlot        TimeSlot?     // صبح، ظهر، عصر، شب
  scheduledTime   DateTime?     // زمان دقیق
  duration        Int?          // مدت زمان در دقیقه
  
  itemType        PlanItemType
  restaurantId    String?
  restaurant      Restaurant?   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  placeId         String?
  place           TouristPlace? @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  travelDuration  Int?          // مدت زمان سفر به مقصد بعدی (برای TRAVEL)
  distance        Float?        // فاصله تا مقصد بعدی
  
  notes           String?       // یادداشت کاربر
  tips            String?       // نکات و توصیه‌ها
  
  isCompleted     Boolean       @default(false)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([planId])
  @@index([order])
  @@map("travel_plan_items")
}

// ==================== Travel Checklists ====================

enum ChecklistTravelType {
  FAMILY_WITH_KIDS
  NATURE
  BEACH
  URBAN
  COUPLE
  FRIENDS
  SOLO
  OTHER
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL
}

model TravelChecklistTemplate {
  id          String   @id @default(cuid())
  title       String
  description String?
  icon        String?
  travelType  ChecklistTravelType?
  season      Season?  @default(ALL)
  isActive    Boolean  @default(true)
  
  createdById String
  createdBy   User     @relation("ChecklistTemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  items       ChecklistTemplateItem[]
  checklists  TravelChecklist[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([travelType])
  @@index([isActive])
  @@index([createdById])
  @@map("checklist_templates")
}

model TravelChecklist {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserChecklists", fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  notes       String?  // یادداشت کلی برای چک‌لیست
  templateId  String?
  template    TravelChecklistTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  travelType  ChecklistTravelType?
  season      Season?
  isShared    Boolean  @default(false)
  
  items       ChecklistItem[]
  comments    Comment[] @relation("ChecklistComments")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([travelType])
  @@index([templateId])
  @@map("travel_checklists")
}

model ChecklistTemplateItem {
  id              String   @id @default(cuid())
  name            String
  description     String?
  order           Int      @default(0)
  isRequired      Boolean  @default(false)
  
  templateId      String
  template        TravelChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([templateId])
  @@index([order])
  @@map("checklist_template_items")
}

model ChecklistItem {
  id              String   @id @default(cuid())
  name            String
  description     String?
  order           Int      @default(0)
  isRequired      Boolean  @default(false)
  isChecked       Boolean  @default(false)
  notes           String?
  
  checklistId     String
  checklist       TravelChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  
  templateItemId  String? // برای ردیابی آیتم اصلی در قالب (اختیاری)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([checklistId])
  @@index([order])
  @@map("checklist_items")
}

// ==================== Comments System ====================

enum CommentStatus {
  ACTIVE      // نمایش داده می‌شود
  CENSORED    // کلمات بد دارد و ستاره‌گذاری شده
  HIDDEN      // مخفی شده توسط ادمین
  DELETED     // حذف شده
}

enum CommentItemType {
  RESTAURANT
  PLACE
  CHECKLIST
}

enum ReportReason {
  OFFENSIVE_CONTENT  // محتوای توهین‌آمیز
  SPAM              // اسپم
  ADVERTISEMENT     // تبلیغات
  FALSE_INFO        // اطلاعات غلط
  BAD_WORDS         // کلمات بد
  OTHER             // دیگر موارد
}

enum BadWordSeverity {
  MILD      // خفیف
  MODERATE  // متوسط
  SEVERE    // شدید
}

model Comment {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  
  // نوع آیتم و ID
  itemType        CommentItemType
  restaurantId    String?
  restaurant      Restaurant?       @relation("RestaurantComments", fields: [restaurantId], references: [id], onDelete: Cascade)
  placeId         String?
  place           TouristPlace?     @relation("PlaceComments", fields: [placeId], references: [id], onDelete: Cascade)
  checklistId     String?
  checklist       TravelChecklist?  @relation("ChecklistComments", fields: [checklistId], references: [id], onDelete: Cascade)
  
  // محتوا
  content         String            // متن اصلی (فقط برای ادمین)
  censoredContent String            // متن سانسور شده (برای نمایش)
  hasBadWords     Boolean           @default(false) // آیا کلمات بد دارد
  status          CommentStatus    @default(ACTIVE)
  
  // آمار
  likeCount       Int               @default(0)
  reportCount     Int               @default(0)
  
  // Relations
  likes           CommentLikeNew[]
  reports         CommentReportNew[]
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([userId])
  @@index([restaurantId])
  @@index([placeId])
  @@index([checklistId])
  @@index([itemType])
  @@index([status])
  @@index([hasBadWords])
  @@index([createdAt])
  @@index([itemType, status, createdAt]) // Composite index برای query های رایج
  @@index([restaurantId, status, createdAt]) // برای رستوران‌ها
  @@index([placeId, status, createdAt]) // برای مکان‌ها
  @@map("comments")
}

model CommentLikeNew {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation("CommentLikeUser", fields: [userId], references: [id], onDelete: Cascade)
  commentId String
  comment   Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([userId, commentId])
  @@index([commentId])
  @@map("comment_likes_new")
}

model CommentReportNew {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation("CommentReportUser", fields: [userId], references: [id], onDelete: Cascade)
  commentId String
  comment   Comment       @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reason    ReportReason
  status    String        @default("pending") // pending, reviewed, resolved
  createdAt DateTime      @default(now())

  @@index([commentId])
  @@index([status])
  @@map("comment_reports_new")
}

// ==================== Bad Words Management ====================

model BadWord {
  id        String            @id @default(cuid())
  word      String            @unique
  severity  BadWordSeverity   @default(MODERATE)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([word])
  @@index([isActive])
  @@map("bad_words")
}
